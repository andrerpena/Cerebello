(function(b){function a(c){this.defaults={objectType:null,objectName:null,title:null,canClose:true,showTextBox:true,initialToggleState:"maximized",onClose:function(d){},onToggleStateChanged:function(d){}};this.opts=b.extend({},this.defaults,c);this.$el=null;this.$window=null;this.$windowTitle=null;this.$windowContent=null;this.$windowInnerContent=null;this.$textBox=null}a.prototype={init:function(){var e=this;e.$window=b("<div/>").addClass("chat-window").appendTo(b("body"));e.$windowTitle=b("<div/>").addClass("chat-window-title").appendTo(e.$window);if(e.opts.canClose){var d=b("<div/>").addClass("close").appendTo(e.$windowTitle);d.click(function(g){g.stopPropagation();for(var f=0;f<b._chatContainers.length;f++){if(b._chatContainers[f]==e){b._chatContainers.splice(f,1);break}}e.$window.remove();e.opts.onClose(e)})}b("<div/>").addClass("text").text(e.opts.title).appendTo(e.$windowTitle);e.$windowContent=b("<div/>").addClass("chat-window-content").appendTo(e.$window);if(e.opts.initialToggleState=="minimized"){e.$windowContent.hide()}e.$windowInnerContent=b("<div/>").addClass("chat-window-inner-content").appendTo(e.$windowContent);if(e.opts.showTextBox){var c=b("<div/>").addClass("chat-window-text-box-wrapper").appendTo(e.$windowContent);e.$textBox=b("<input/>").attr("type","text").addClass("chat-window-text-box").appendTo(c)}e.$windowTitle.click(function(){e.$windowContent.toggle();if(e.$windowContent.is(":visible")&&e.opts.showTextBox){e.$textBox.focus()}e.opts.onToggleStateChanged(e.$windowContent.is(":visible")?"maximized":"minimized")});if(!b._chatContainers){b._chatContainers=new Array()}b._chatContainers.push(e);b.organizeChatContainers()},getContent:function(){var c=this;return c.$windowInnerContent},setTitle:function(c){var d=this;b("div[class=text]",d.$windowTitle).text(c)},setVisible:function(c){var d=this;if(c){d.$window.show()}else{d.$window.hide()}},getToggleState:function(){var c=this;return c.$windowContent.is(":visible")?"maximized":"minimized"},setToggleState:function(c){var d=this;if(c=="minimized"){d.$windowContent.hide()}else{if(c=="maximized"){d.$windowContent.show()}}}};b.chatContainer=function(c){var d=new a(c);d.init();return d};b.organizeChatContainers=function(){var e=30;var d=20;for(var c=0;c<b._chatContainers.length;c++){b._chatContainers[c].$window.css("right",e);e+=b._chatContainers[c].$window.outerWidth()+d}}})(jQuery);(function(b){function a(c){this.defaults={practice:null,myUser:null,otherUser:null,initialToggleState:"maximized",initialFocusState:"focused",userIsOnline:false,hub:null,onReady:function(){},onClose:function(){},onToggleStateChanged:function(d){}};this.opts=b.extend({},this.defaults,c);this.$el=null;this.chatContainer=null;this.addMessage=function(k,d){var h=this;h.chatContainer.setToggleState("maximized");if(k.UserFrom.Id!=this.opts.myUser.Id){h.removeTypingSignal()}function g(o){var r=o.html();var n,q,p,m;q=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;n=r.replace(q,'<a href="$1" target="_blank">$1</a>');p=/(^|[^\/])(www\.[\S]+(\b|$))/gim;n=n.replace(p,'$1<a href="http://$2" target="_blank">$2</a>');m=/(\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,6})/gim;n=n.replace(m,'<a href="mailto:$1">$1</a>');return o.html(n)}if(k.ClientGuid&&b("p[data-val-client-guid='"+k.ClientGuid+"']").length){b("p[data-val-client-guid='"+k.ClientGuid+"']").removeClass("temp-message").removeAttr("data-val-client-guid")}else{var i=b("<p/>").text(k.Message);if(d){i.attr("data-val-client-guid",d).addClass("temp-message")}g(i);var l=b("div.chat-message:last",h.chatContainer.$windowInnerContent);if(l.length&&l.attr("data-val-user-from")==k.UserFrom.Id){i.appendTo(b(".chat-text-wrapper",l))}else{var f=b("<div/>").addClass("chat-message").attr("data-val-user-from",k.UserFrom.Id);f.appendTo(h.chatContainer.$windowInnerContent);var e=b("<div/>").addClass("chat-gravatar-wrapper").appendTo(f);var j=b("<div/>").addClass("chat-text-wrapper").appendTo(f);i.appendTo(j);b("<img/>").attr("src",decodeURI(k.UserFrom.GravatarUrl)).appendTo(e)}h.chatContainer.$windowInnerContent.scrollTop(h.chatContainer.$windowInnerContent[0].scrollHeight)}};this.sendMessage=function(e){var f=this;var d=generateGuid();f.addMessage({UserFrom:f.opts.myUser,Message:e},d);f.opts.hub.server.sendMessage(f.opts.otherUser.Id,e,d)};this.sendTypingSignal=function(){var d=this;d.opts.hub.server.sendTypingSignal(d.opts.otherUser.Id)};this.getToggleState=function(){var d=this;return d.chatContainer.getToggleState()};this.setVisible=function(d){var e=this;e.chatContainer.setVisible(d)}}a.prototype={init:function(){var c=this;c.chatContainer=b.chatContainer({title:c.opts.userToName,canClose:true,initialToggleState:c.opts.initialToggleState,onClose:function(d){c.opts.onClose(d)},onToggleStateChanged:function(d){c.opts.onToggleStateChanged(d)}});c.chatContainer.$textBox.keypress(function(d){if(c.$sendTypingSignalTimeout==undefined){c.$sendTypingSignalTimeout=setTimeout(function(){c.$sendTypingSignalTimeout=undefined},3000);c.sendTypingSignal()}if(d.which==13){d.preventDefault();if(b(this).val()){c.sendMessage(b(this).val());b(this).val("")}}});c.chatContainer.setTitle(c.opts.otherUser.Name);c.opts.hub.server.getMessageHistory(c.opts.otherUser.Id).done(function(e){for(var d=0;d<e.length;d++){c.addMessage(e[d])}c.chatContainer.setVisible(true);if(c.opts.initialFocusState=="focused"){c.chatContainer.$textBox.focus()}c.chatContainer.$windowInnerContent.scrollTop(c.chatContainer.$windowInnerContent[0].scrollHeight);if(c.opts.onReady){c.opts.onReady(c)}});c.setOnlineStatus(c.opts.userIsOnline)},focus:function(){var c=this;c.chatContainer.$textBox.focus()},showTypingSignal:function(c){var d=this;if(d.$typingSignal){d.$typingSignal.remove()}d.$typingSignal=b("<p/>").addClass("typing-signal").text(c.Name+" está digitando...");d.chatContainer.$windowInnerContent.after(d.$typingSignal);if(d.typingSignalTimeout){clearTimeout(d.typingSignalTimeout)}d.typingSignalTimeout=setTimeout(function(){d.removeTypingSignal()},5000)},removeTypingSignal:function(){var c=this;if(c.$typingSignal){c.$typingSignal.remove()}if(c.typingSignalTimeout){clearTimeout(c.typingSignalTimeout)}},setOnlineStatus:function(c){var d=this;if(c){d.chatContainer.$windowTitle.addClass("online");d.chatContainer.$windowTitle.removeClass("offline")}else{d.chatContainer.$windowTitle.removeClass("online");d.chatContainer.$windowTitle.addClass("offline")}}};b.chatWindow=function(c){var d=new a(c);d.init();return d}})(jQuery);(function(a){function b(c){this.defaults={user:null,practice:null};this.opts=a.extend({},this.defaults,c);this.$el=null;this.chatWindows=new Object();this.lastMessageCheckTimeStamp=null;this.chatContainer=null;this.createNewChatWindow=function(d,g,e){var h=this;if(!g){g="maximized"}if(!e){e="focused"}var f=a.chatWindow({practice:h.opts.practice,myUser:h.opts.user,otherUser:d,newMessageUrl:h.opts.newMessageUrl,messageHistoryUrl:h.opts.messageHistoryUrl,initialToggleState:g,initialFocusState:e,userIsOnline:d.Status==1,hub:h.hub,onClose:function(){delete h.chatWindows[d.Id];a.organizeChatContainers();h.saveWindows()},onToggleStateChanged:function(i){h.saveWindows()}});h.chatWindows[d.Id.toString()]=f;h.saveWindows()};this.processUserListAjaxResult=function(e){var h=this;h.chatContainer.getContent().html("");if(e.length==1){a("<div/>").addClass("user-list-empty").text("Não existem outros usuários").appendTo(h.chatContainer.getContent())}else{var g=new Object();for(var d=0;d<e.length;d++){if(e[d].Id!=h.opts.user.Id){g[e[d].Id]=e[d];var f=a("<div/>").addClass("user-list-item").attr("data-val-id",e[d].Id).appendTo(h.chatContainer.getContent());a("<img/>").addClass("profile-picture").attr("src",e[d].GravatarUrl).appendTo(f);a("<img/>").addClass("status-picture").attr("src",e[d].Status==0?"/content/images/app/chat/chat-offline.png":"/content/images/app/chat/chat-online.png").appendTo(f);a("<div/>").addClass("content").text(e[d].Name).appendTo(f);(function(i){f.click(function(){if(h.chatWindows[e[i].Id]){h.chatWindows[e[i].Id].focus()}else{h.createNewChatWindow(e[i])}})})(d)}}for(var d in h.chatWindows){if(g[d]){h.chatWindows[d].setOnlineStatus(g[d].Status==1)}else{h.chatWindows[d].setOnlineStatus(false)}}}h.chatContainer.setVisible(true)};this.saveWindows=function(){var f=this;var d=new Array();for(var e in f.chatWindows){d.push({userId:e,toggleState:f.chatWindows[e].getToggleState()})}createCookie("chat_state",JSON.stringify(d),365)};this.loadWindows=function(){var h=this;var f=readCookie("chat_state");if(f){var d=JSON.parse(f);for(var e=0;e<d.length;e++){var g=d[e].userId;h.hub.server.getUserInfo(g).done(function(i){if(i){if(!h.chatWindows[g]){h.createNewChatWindow(i,null,"blured")}}else{eraseCookie("chat_state")}})}}};this.playSound=function(d){var e=a("#soundContainer");if(!e.length){e=a("<div>").attr("id","soundContainer").appendTo(a("body"))}e.html('<audio autoplay="autoplay"><source src="'+d+'.mp3" type="audio/mpeg" /><source src="'+d+'.ogg" type="audio/ogg" /><embed hidden="true" autostart="true" loop="false" src="'+d+'.mp3" /></audio>')}}b.prototype={init:function(){var d=this;var c=readCookie("main_window_chat_state");if(!c){c="maximized"}d.chatContainer=a.chatContainer({title:"Bate-papo",showTextBox:false,canClose:false,initialToggleState:c,onToggleStateChanged:function(e){createCookie("main_window_chat_state",e)}});d.hub=a.connection.chatHub;d.hub.client.sendMessage=function(e){if(e.UserFrom.Id!=d.opts.user.Id){if(!d.chatWindows[e.UserFrom.Id]){d.createNewChatWindow(e.UserFrom)}else{d.chatWindows[e.UserFrom.Id].addMessage(e)}d.playSound("/content/sounds/chat")}else{if(d.chatWindows[e.UserTo.Id]){d.chatWindows[e.UserTo.Id].addMessage(e)}}};d.hub.client.sendTypingSignal=function(e){if(d.chatWindows[e.Id]){d.chatWindows[e.Id].showTypingSignal(e)}};d.hub.client.usersListChanged=function(e){d.processUserListAjaxResult(e)};if(!window.hubReady){window.hubReady=a.connection.hub.start()}window.hubReady.done(function(){d.loadWindows()})}};a.chatUserList=function(c){var d=new b(c);d.init();return d}})(jQuery);