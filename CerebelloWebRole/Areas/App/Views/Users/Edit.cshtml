@model CerebelloWebRole.Areas.App.Models.UserViewModel
@using CerebelloWebRole.Areas.App.Models
@using CerebelloWebRole.Code.Controls
@using CerebelloWebRole.Code.Extensions
@{
    if (this.Model != null && this.Model.Id.HasValue)
    {
        ViewBag.Title = "Editando usuário: " + this.Model.FullName + " · Cerebello";
    }
    else
    {
        ViewBag.Title = "Novo usuário · Cerebello";
    }

    Layout = "~/Areas/App/Views/Shared/_LayoutPractice.cshtml";

    var editPanel = this.Html.CreateEditPanel();

    if (this.ViewBag.IsEditingOrCreating == 'C')
    {
        // If Model is null, then the user is being created now,
        // so we allow the user name to be changed.
        editPanel.AddField(m => m.UserName, EditPanelFieldSize.Large);
    }
    else if (this.ViewBag.IsEditingOrCreating == 'E')
    {
        // If Model is not null, then the user already existed before,
        // we cannot allow the user-name to be edited.
        editPanel.AddTextField(m => m.UserName);
    }
    else
    {
        throw new Exception("'ViewBag.IsEditingOrCreating' must be either 'E' or 'C'.");
    }

    editPanel.AddField(m => m.FullName, EditPanelFieldSize.Large);
    editPanel.AddField(m => m.Gender, format: @<text>@Html.EnumDropdownListFor(model => model.Gender)</text>);
    editPanel.AddField(m => m.DateOfBirth, EditPanelFieldSize.Small);
    editPanel.AddField(m => m.MaritalStatus, format: @<text>@Html.EnumDropdownListFor(model => model.MaritalStatus)</text>);
    editPanel.AddField(m => m.BirthPlace);
    editPanel.AddField(m => m.CPF);
    editPanel.AddField(m => m.Profissao);

    var editPanelRoles = this.Html.CreateEditPanel();
    editPanelRoles.AddField(m => m.IsAdministrador);
    editPanelRoles.AddField(m => m.IsSecretary);
    editPanelRoles.AddField(m => m.IsDoctor);

    var editPanelMedic = this.Html.CreateEditPanel();
    editPanelMedic.AddField(m => m.MedicCRM);

    // These objects must be filled, otherwise obscure exceptions may happen.
    // - ViewBag.MedicalSpecialtyOptions
    // - ViewBag.MedicalEntityOptions
    if (!(this.ViewBag.MedicalSpecialtyOptions is IEnumerable<SelectListItem>))
    {
        throw new Exception("ViewBag.MedicalSpecialtyOptions is not of type 'IEnumerable<SelectListItem>'.");
    }
    if (!(this.ViewBag.MedicalSpecialtyOptions is IEnumerable<SelectListItem>))
    {
        throw new Exception("ViewBag.MedicalEntityOptions is not of type 'IEnumerable<SelectListItem>'.");
    }

    editPanelMedic.AddField(
        m => m.MedicalSpecialtyId,
        EditPanelFieldSize.Large,
        format: @<text>@(Html.LookupGridFor<UserViewModel, MedicalSpecialtiesLookupGridModel, int?>(
                                m => m.MedicalSpecialtyId,
                                m => m.MedicalSpecialtyName,
                                Url.Action("LookupMedicalSpecialties", "MedicalSpecialties"),
                                pm => pm.Id,
                                pm => pm.Name,
                                pm => pm.Code))
                             </text>);

    editPanelMedic.AddField(
        m => m.MedicalEntityId,
        EditPanelFieldSize.Large,
        format: @<text>@Html.DropDownListFor(
            m => m.MedicalEntityId,
            (IEnumerable<SelectListItem>)this.ViewBag.MedicalEntityOptions,
            "")</text>);

    editPanelMedic.AddField(
        m => m.MedicalEntityJurisdiction,
        format: @<text>@Html.EnumDropdownListFor(model => model.MedicalEntityJurisdiction)</text>);

    var editPanelContact = this.Html.CreateEditPanel();
    editPanelContact.AddField(m => m.Email);
    editPanelContact.AddField(m => m.PhoneCell);
    editPanelContact.AddField(m => m.PhoneLand);
}
@section Scripts {
    <script type="text/javascript">
        $(function () {
            $('#IsDoctor').change(function () {
                if ($(this).is(':checked')) $('#MedicEditPanel').show();
                else $('#MedicEditPanel').hide();
            });

            if ($('#IsDoctor').is(':checked')) $('#MedicEditPanel').show();
            else $('#MedicEditPanel').hide();
        });
    </script>
}

@section Title {
    @if (this.Model != null && this.Model.Id.HasValue)
    {
        @:Editando usuário: @this.Model.FullName
    }
    else
    {
        @:Novo usuário
    }
}
@section SideBar {
    <a href="@Url.Action("index")" class="icon-link icon-link-home">Resumo de usuários</a>
}
@using (Html.BeginForm())
{
    @Html.ValidationSummary(false)

    @editPanel.GetHtml()

    if (this.Model == null)
    { 
    @Html.Message(string.Format(
        "A senha padrão deste usuário é {0}. Essa senha será usada somente para fazer o primeiro acesso ao sistema.",
        CerebelloWebRole.Code.Constants.DEFAULT_PASSWORD))
    }
    
    <h2>
        Funções deste usuário
    </h2>
    
    @editPanelRoles.GetHtml()
    
    <div id="MedicEditPanel" @(new MvcHtmlString(Model != null && Model.IsDoctor ? "" : "style=\"display: none\""))>
        <h2>
            Informações do médico
        </h2>
        @editPanelMedic.GetHtml()
    </div>
    
    <h2>
        @Html.LabelFor(model => model.Address)
    </h2>

    @Html.EditorFor(model => model.Address);

    <h2>
        Informações de contato
    </h2>
    
    @editPanelContact.GetHtml()

    <div class="submit-bar">
        <input type="submit" value="salvar usuário" />
        <span class="separator">ou</span>
        @Html.ActionLink("cancelar", "Index")
    </div>
}
